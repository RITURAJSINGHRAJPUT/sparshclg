<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Sparsh NFC</title>
    <meta name="description" content="Admin dashboard for managing products, orders, and users">
    <link rel="icon" href="https://placehold.co/32x32/C8B6FF/FFD6FF?text=A" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="auth-modular.js"></script>
    <script type="module" src="admin-functions.js"></script>
    <script src="export-utils.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --color-primary: #4c46d9;
            --color-secondary: #eef2ff;
            --color-accent: #0f172a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
        }

        .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
        }

        .nav-item {
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(76, 70, 217, 0.2);
            border-left: 3px solid var(--color-primary);
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex !important;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar w-64 text-white p-6 flex flex-col">
            <div class="mb-8">
                <h1 class="text-2xl font-extrabold mb-2">Sparsh NFC</h1>
                <p class="text-sm text-slate-400">Admin Dashboard</p>
            </div>

            <nav class="flex-1 space-y-2">
                <a href="#" data-section="products" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    Products
                </a>
                <a href="#" data-section="orders" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Orders
                </a>
                <a href="#" data-section="users" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    Users
                </a>
                <a href="#" data-section="analytics" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Analytics
                </a>
            </nav>

            <div class="pt-4 border-t border-slate-700">
                <button onclick="viewAdminProfile()" class="w-full flex items-center gap-3 px-4 py-3 mb-4 hover:bg-slate-800 rounded-lg transition">
                    <div class="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center font-bold" id="admin-initials">
                        A
                    </div>
                    <div class="flex-1 text-left">
                        <p class="text-sm font-semibold" id="admin-name">Admin</p>
                        <p class="text-xs text-slate-400" id="admin-email">admin@sparsh.com</p>
                    </div>
                    <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <a href="index.html" class="block px-4 py-2 text-sm text-slate-300 hover:text-white transition">← Back to Site</a>
                <button id="logout-btn" class="w-full mt-2 px-4 py-2 text-sm bg-red-600 hover:bg-red-700 rounded-lg transition">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <div class="p-8">
                <!-- Products Section -->
                <section id="products-section" class="section-content">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-3xl font-extrabold text-slate-900">Products</h2>
                            <p class="text-slate-600 mt-1">Manage your NFC card products</p>
                        </div>
                        <button id="add-product-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition shadow-lg">
                            + Add Product
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Image</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Name</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Type</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Price</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">SKU</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Status</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body" class="divide-y divide-slate-200">
                                    <tr>
                                        <td colspan="7" class="px-6 py-8 text-center text-slate-500">Loading products...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Orders Section -->
                <section id="orders-section" class="section-content hidden">
                    <div class="mb-6">
                        <h2 class="text-3xl font-extrabold text-slate-900">Orders</h2>
                        <p class="text-slate-600 mt-1">View and manage customer orders</p>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="exportOrdersData('csv')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
                        <button onclick="exportOrdersData('pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Export PDF</button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Order ID</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Customer</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Items</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Total</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Status</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Date</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body" class="divide-y divide-slate-200">
                                    <tr>
                                        <td colspan="7" class="px-6 py-8 text-center text-slate-500">Loading orders...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Users Section -->
                <section id="users-section" class="section-content hidden">
                    <div class="mb-6">
                        <h2 class="text-3xl font-extrabold text-slate-900">Users</h2>
                        <p class="text-slate-600 mt-1">View registered users</p>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="exportUsersData('csv')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Export CSV</button>
                        <button onclick="exportUsersData('pdf')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Export PDF</button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="table-container">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Name</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Email</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Phone</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">City</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Joined</th>
                                        <th class="px-6 py-4 text-left text-xs font-semibold text-slate-700 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body" class="divide-y divide-slate-200">
                                    <tr>
                                        <td colspan="6" class="px-6 py-8 text-center text-slate-500">Loading users...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section id="analytics-section" class="section-content hidden">
                    <div class="mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-3xl font-extrabold text-slate-900">Analytics</h2>
                                <p class="text-slate-600 mt-1">Overview of sales and user activity</p>
                            </div>
                            <div class="flex gap-2">
                                <select id="analytics-range" class="px-3 py-2 border rounded-lg">
                                    <option value="7">Last 7 days</option>
                                    <option value="30" selected>Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                </select>
                                <button id="refresh-analytics" class="px-4 py-2 bg-slate-100 rounded-lg hover:bg-slate-200">Refresh</button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl shadow p-4">
                            <p class="text-slate-500 text-sm">Total Orders</p>
                            <p id="stat-orders" class="text-2xl font-bold mt-1">-</p>
                        </div>
                        <div class="bg-white rounded-xl shadow p-4">
                            <p class="text-slate-500 text-sm">Revenue</p>
                            <p id="stat-revenue" class="text-2xl font-bold mt-1">-</p>
                        </div>
                        <div class="bg-white rounded-xl shadow p-4">
                            <p class="text-slate-500 text-sm">Avg Order Value</p>
                            <p id="stat-aov" class="text-2xl font-bold mt-1">-</p>
                        </div>
                        <div class="bg-white rounded-xl shadow p-4">
                            <p class="text-slate-500 text-sm">Users</p>
                            <p id="stat-users" class="text-2xl font-bold mt-1">-</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6 mb-6">
                        <h3 class="font-semibold text-slate-700 mb-4">Recent Orders</h3>
                        <div id="recent-orders" class="space-y-3"></div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-extrabold text-slate-900" id="modal-title">Add Product</h3>
                <button id="close-modal" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id">
                
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Product Name *</label>
                    <input type="text" id="product-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Type *</label>
                    <select id="product-type" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <option value="">Select Type</option>
                        <option value="classic">Classic</option>
                        <option value="premium">Premium</option>
                        <option value="corporate">Corporate</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Price (₹) *</label>
                        <input type="number" id="product-price" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">SKU *</label>
                        <input type="text" id="product-sku" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Product Image *</label>
                    <div class="space-y-2">
                        <input type="file" id="product-image-file" accept="image/*" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <div id="image-upload-progress" class="hidden">
                            <div class="w-full bg-slate-200 rounded-full h-2">
                                <div id="image-progress-bar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-slate-600 mt-1" id="image-progress-text">Uploading...</p>
                        </div>
                        <div class="text-sm text-slate-500">Or enter image URL:</div>
                        <input type="url" id="product-image-url" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://example.com/image.jpg">
                        <input type="hidden" id="product-image" required>
                        <div id="image-preview" class="hidden mt-2">
                            <img id="preview-img" class="w-32 h-32 object-cover rounded-lg border" />
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Description</label>
                    <textarea id="product-description" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Available Finishes (comma-separated)</label>
                    <input type="text" id="product-finishes" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Black Matte, White Gloss, Silver Metallic">
                </div>

                <div>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="product-active" class="w-4 h-4 text-indigo-600 border-slate-300 rounded">
                        <span class="text-sm font-semibold text-slate-700">Active (visible to customers)</span>
                    </label>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="submit" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">
                        Save Product
                    </button>
                    <button type="button" id="cancel-modal" class="px-6 py-3 bg-slate-200 text-slate-700 rounded-lg font-semibold hover:bg-slate-300 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-extrabold text-slate-900">Order Details</h3>
                <button id="close-order-modal" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="order-details-content" class="space-y-4">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-extrabold text-slate-900">User Profile</h3>
                <button id="close-user-modal" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="user-details-content" class="space-y-4">
                <!-- User details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Wait for both auth and admin functions to be available
        function waitForAdminFunctions(callback, maxAttempts = 30) {
            let attempts = 0;
            const checkFunctions = setInterval(() => {
                attempts++;
                if (typeof sparshAuth !== 'undefined' && typeof adminFunctions !== 'undefined') {
                    clearInterval(checkFunctions);
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkFunctions);
                    console.error('Admin functions or auth not available');
                    console.log('sparshAuth available:', typeof sparshAuth !== 'undefined');
                    console.log('adminFunctions available:', typeof adminFunctions !== 'undefined');
                    alert('Admin functions not loaded. Please refresh the page.');
                }
            }, 300);
        }

        // Wait for auth state to be ready
        function waitForAuthState(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkAuth = setInterval(() => {
                attempts++;
                if (typeof sparshAuth !== 'undefined' && sparshAuth.isAuthenticated && sparshAuth.getCurrentUser) {
                    // Check if user is authenticated or wait a bit more for auth state to settle
                    const user = sparshAuth.getCurrentUser();
                    if (user || attempts >= 10) {
                        clearInterval(checkAuth);
                        callback();
                    }
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkAuth);
                    callback(); // Proceed anyway
                }
            }, 200);
        }

        document.addEventListener('DOMContentLoaded', function() {
            waitForAdminFunctions(() => {
                waitForAuthState(() => {
                    initializeAdminDashboard();
                });
            });
        });

        async function initializeAdminDashboard() {
            console.log('Initializing admin dashboard...');
            console.log('sparshAuth available:', typeof sparshAuth !== 'undefined');
            console.log('adminFunctions available:', typeof adminFunctions !== 'undefined');
            
            // First check: If admin email is in sessionStorage, allow access immediately
            const adminEmailFromSession = sessionStorage.getItem('adminEmail') || localStorage.getItem('adminEmail');
            if (adminEmailFromSession && adminEmailFromSession.toLowerCase() === 'admin@gmail.com') {
                console.log('Admin email found in storage, allowing access');
                const user = { email: adminEmailFromSession, uid: 'admin', displayName: 'Admin' };
                loadDashboardContent(user);
                return;
            }
            
            // Wait a bit more for auth state to be ready
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Check authentication
            if (typeof sparshAuth === 'undefined') {
                console.error('sparshAuth is undefined');
                // Check if admin email is in storage as last resort
                if (adminEmailFromSession) {
                    const user = { email: adminEmailFromSession, uid: 'admin', displayName: 'Admin' };
                    loadDashboardContent(user);
                    return;
                }
                alert('Authentication service not loaded. Please refresh the page.');
                window.location.href = 'login.html';
                return;
            }
            
            // Get current user - try multiple methods
            let user = null;
            
            // Method 1: Try getCurrentUser
            if (sparshAuth.getCurrentUser) {
                user = sparshAuth.getCurrentUser();
                console.log('User from getCurrentUser:', user);
            }
            
            // Method 2: Check localStorage as fallback
            if (!user) {
                console.log('No current user from auth, checking localStorage...');
                const storedUser = localStorage.getItem('sparshUser');
                if (storedUser) {
                    try {
                        const userData = JSON.parse(storedUser);
                        user = { 
                            email: userData.email || userData.user?.email, 
                            uid: userData.uid || userData.user?.uid, 
                            displayName: userData.displayName || userData.user?.displayName 
                        };
                        console.log('Using stored user from localStorage:', user);
                    } catch (e) {
                        console.error('Error parsing stored user:', e);
                    }
                }
            }
            
            // Method 3: Check if authenticated but user object not available
            if (!user && sparshAuth.isAuthenticated && sparshAuth.isAuthenticated()) {
                console.log('User is authenticated but user object not available, waiting...');
                // Wait a bit more for auth state
                await new Promise(resolve => setTimeout(resolve, 1000));
                user = sparshAuth.getCurrentUser();
                console.log('User after wait:', user);
            }
            
            // If no user found, check if we can get email from URL params or session
            if (!user || !user.email) {
                // Last resort: check if admin email is in sessionStorage or try to proceed with admin check
                const adminEmailFromStorage = sessionStorage.getItem('adminEmail') || localStorage.getItem('adminEmail');
                if (adminEmailFromStorage && adminEmailFromStorage.toLowerCase() === 'admin@gmail.com') {
                    user = { email: adminEmailFromStorage, uid: 'admin', displayName: 'Admin' };
                    console.log('Using admin email from storage:', user);
                } else {
                    console.error('Unable to get user information');
                    console.log('sparshAuth.isAuthenticated():', sparshAuth.isAuthenticated ? sparshAuth.isAuthenticated() : 'N/A');
                    console.log('localStorage sparshUser:', localStorage.getItem('sparshUser'));
                    
                    // Don't redirect if we're in the middle of viewing a profile
                    const userModal = document.getElementById('user-details-modal');
                    if (userModal && userModal.classList.contains('show')) {
                        console.log('Modal is open, not redirecting to prevent interruption');
                        return;
                    }
                    
                    alert('Unable to get user information. Please login again with admin credentials:\nEmail: admin@gmail.com\nPassword: 799020');
                    window.location.href = 'login.html';
                    return;
                }
            }
            
            console.log('Current user email:', user.email);

            // Check if user is admin (hardcoded check first)
            const ADMIN_EMAIL = 'admin@gmail.com';
            const isHardcodedAdmin = user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
            
            if (isHardcodedAdmin) {
                // User is admin by hardcoded email - allow access
                console.log('Admin access granted via hardcoded email');
                // Store admin email for future reference
                sessionStorage.setItem('adminEmail', user.email);
            } else {
                // Check Firestore admin status
                try {
                    const adminCheck = await adminFunctions.isAdmin(user.email);
                    if (!adminCheck.success || !adminCheck.isAdmin) {
                        // Check if admin is not set yet (first time setup)
                        const adminResult = await adminFunctions.getAdminEmail();
                        if (adminResult.success && !adminResult.adminEmail) {
                            // First time - set this user as admin
                            const setResult = await adminFunctions.setAdminEmail(user.email);
                            if (setResult.success) {
                                alert('You have been set as the admin. Please refresh the page.');
                                location.reload();
                                return;
                            }
                        } else {
                            alert('Access denied. Only admin can access this dashboard.\n\nPlease login with:\nEmail: admin@gmail.com\nPassword: 799020');
                            window.location.href = 'index.html';
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error checking admin status:', error);
                    // If admin check fails but email is admin@gmail.com, allow anyway
                    if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                        console.log('Admin check failed but email matches, allowing access');
                    } else {
                        alert('Error checking admin status. Please try again.');
                        window.location.href = 'login.html';
                        return;
                    }
                }
            }

            // Load dashboard content
            loadDashboardContent(user);
        }

        function loadDashboardContent(user) {
            // Load admin info
            if (user && user.email) {
                document.getElementById('admin-email').textContent = user.email;
                document.getElementById('admin-name').textContent = user.displayName || 'Admin';
                const initials = (user.displayName || user.email).charAt(0).toUpperCase();
                document.getElementById('admin-initials').textContent = initials;
                
                // Log authentication state for debugging
                console.log('Admin dashboard loaded for:', user.email);
                console.log('User UID:', user.uid);
                if (typeof sparshAuth !== 'undefined' && sparshAuth.getCurrentUser) {
                    const currentUser = sparshAuth.getCurrentUser();
                    console.log('Current Firebase user:', currentUser);
                    if (currentUser) {
                        console.log('Firebase user email:', currentUser.email);
                        console.log('Firebase user UID:', currentUser.uid);
                    }
                }
            }

            // Navigation
            let initialSectionSet = false;
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    // Persist last selected section
                    try { sessionStorage.setItem('adminLastSection', section); } catch {}
                    initialSectionSet = true;

                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Logout
            document.getElementById('logout-btn').addEventListener('click', async function() {
                if (confirm('Are you sure you want to logout?')) {
                    if (typeof sparshAuth !== 'undefined' && sparshAuth.signOut) {
                        await sparshAuth.signOut();
                    }
                    window.location.href = 'index.html';
                }
            });

            // Product modal
            const productModal = document.getElementById('product-modal');
            const addProductBtn = document.getElementById('add-product-btn');
            const closeModalBtn = document.getElementById('close-modal');
            const cancelModalBtn = document.getElementById('cancel-modal');
            const productForm = document.getElementById('product-form');

            addProductBtn.addEventListener('click', () => {
                document.getElementById('modal-title').textContent = 'Add Product';
                document.getElementById('product-id').value = '';
                productForm.reset();
                document.getElementById('image-preview').classList.add('hidden');
                document.getElementById('image-upload-progress').classList.add('hidden');
                productModal.classList.add('show');
            });

            // Handle image file selection
            const imageFileInput = document.getElementById('product-image-file');
            const imageUrlInput = document.getElementById('product-image-url');
            const hiddenImageInput = document.getElementById('product-image');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');

            imageFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImg.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                    
                    // Upload to Firebase Storage
                    await uploadProductImage(file);
                }
            });

            imageUrlInput.addEventListener('input', (e) => {
                const url = e.target.value;
                if (url) {
                    hiddenImageInput.value = url;
                    previewImg.src = url;
                    imagePreview.classList.remove('hidden');
                }
            });

            closeModalBtn.addEventListener('click', () => {
                productModal.classList.remove('show');
            });

            cancelModalBtn.addEventListener('click', () => {
                productModal.classList.remove('show');
            });

            productForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const productData = {
                    name: document.getElementById('product-name').value,
                    type: document.getElementById('product-type').value,
                    price: parseFloat(document.getElementById('product-price').value),
                    sku: document.getElementById('product-sku').value,
                    image: document.getElementById('product-image').value,
                    description: document.getElementById('product-description').value,
                    finishes: document.getElementById('product-finishes').value.split(',').map(f => f.trim()).filter(f => f),
                    active: document.getElementById('product-active').checked
                };

                const productId = document.getElementById('product-id').value;
                let result;
                
                if (productId) {
                    result = await adminFunctions.updateProduct(productId, productData);
                } else {
                    result = await adminFunctions.addProduct(productData);
                }

                if (result.success) {
                    productModal.classList.remove('show');
                    loadProducts();
                } else {
                    alert('Error: ' + result.error);
                }
            });

            // Order details modal
            const orderModal = document.getElementById('order-details-modal');
            document.getElementById('close-order-modal').addEventListener('click', () => {
                orderModal.classList.remove('show');
            });

            // User details modal
            const userModal = document.getElementById('user-details-modal');
            const closeUserModalBtn = document.getElementById('close-user-modal');

            // Standardized modal closer
            function closeUserDetailsModal() {
                userModal.classList.remove('show');
                // Clear inline styles in case they were set
                userModal.style.display = '';
                userModal.style.opacity = '';
                userModal.style.visibility = '';
            }
            window.closeUserDetailsModal = closeUserDetailsModal;
            
            if (closeUserModalBtn) {
                closeUserModalBtn.addEventListener('click', closeUserDetailsModal);
            }
            
            // Prevent modal from closing when clicking inside modal content
            const userModalContent = userModal.querySelector('.modal-content');
            if (userModalContent) {
                userModalContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            
            // Close modal when clicking on backdrop
            userModal.addEventListener('click', (e) => {
                if (e.target === userModal) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeUserDetailsModal();
                }
            });
            
            // Prevent any navigation from links inside modal
            userModal.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.href && !link.href.startsWith('#')) {
                    // Allow external links to open in new tab, but prevent navigation
                    if (link.target === '_blank') {
                        // External link, allow it
                        return;
                    }
                    // Internal link, prevent navigation
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Prevented navigation from link:', link.href);
                }
            }, true);

            // Load initial data - ensure adminFunctions is ready
            const waitForAdminFunctions = setInterval(() => {
                if (typeof adminFunctions !== 'undefined' && adminFunctions.getAllProducts) {
                    clearInterval(waitForAdminFunctions);
                    if (!initialSectionSet) {
                        const last = (sessionStorage.getItem('adminLastSection') || 'products');
                        // Sync active nav state to last section
                        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                        const targetNav = document.querySelector(`.nav-item[data-section="${last}"]`);
                        if (targetNav) targetNav.classList.add('active');
                        showSection(last);
                        initialSectionSet = true;
                    }
                }
            }, 100);
            
            // Timeout after 10 seconds
            setTimeout(() => {
                clearInterval(waitForAdminFunctions);
                if (!(typeof adminFunctions !== 'undefined' && adminFunctions.getAllProducts)) {
                    console.error('Admin functions not available after waiting');
                    alert('Admin functions not loaded. Please refresh the page.');
                }
            }, 10000);
        }

        function showSection(section) {
            document.querySelectorAll('.section-content').forEach(sec => sec.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');

            if (section === 'products') {
                loadProducts();
            } else if (section === 'orders') {
                loadOrders();
            } else if (section === 'users') {
                loadUsers();
            } else if (section === 'analytics') {
                loadAnalytics();
            }
        }

        async function loadProducts() {
            const tbody = document.getElementById('products-table-body');
            if (!tbody) {
                console.error('Products table body not found');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">Loading products...</td></tr>';

            try {
                if (typeof adminFunctions === 'undefined' || !adminFunctions.getAllProducts) {
                    throw new Error('Admin functions not available');
                }

                const result = await adminFunctions.getAllProducts();
                console.log('Products result:', result);
                
                if (result.success && result.products && result.products.length > 0) {
                    tbody.innerHTML = result.products.map(product => `
                        <tr class="hover:bg-slate-50">
                            <td class="px-6 py-4">
                                <img src="${product.image || 'https://placehold.co/60x40'}" alt="${product.name || 'Product'}" class="w-16 h-12 object-cover rounded">
                            </td>
                            <td class="px-6 py-4 font-semibold text-slate-900">${product.name || 'N/A'}</td>
                            <td class="px-6 py-4 text-slate-600">${product.type || 'N/A'}</td>
                            <td class="px-6 py-4 font-semibold text-slate-900">₹ ${(product.price || 0).toLocaleString('en-IN')}</td>
                            <td class="px-6 py-4 text-slate-600">${product.sku || 'N/A'}</td>
                            <td class="px-6 py-4">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${product.active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${product.active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex gap-2">
                                    <button onclick="editProduct('${product.id}')" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm font-semibold hover:bg-indigo-200 transition">
                                        Edit
                                    </button>
                                    <button onclick="deleteProduct('${product.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm font-semibold hover:bg-red-200 transition">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">No products found. Add your first product!</td></tr>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">Error loading products: ${error.message}</td></tr>`;
            }
        }

        async function loadOrders() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) {
                console.error('Orders table body not found');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">Loading orders...</td></tr>';

            try {
                if (typeof adminFunctions === 'undefined' || !adminFunctions.getAllOrders) {
                    throw new Error('Admin functions not available. Please refresh the page.');
                }

                console.log('Calling getAllOrders...');
                const result = await adminFunctions.getAllOrders();
                console.log('Orders result:', result);
                
                if (!result) {
                    throw new Error('No result returned from getAllOrders');
                }
                
                if (result.error) {
                    console.error('Error in result:', result.error);
                    let errorMsg = result.error;
                    
                    // Provide helpful message for permission errors
                    if (result.error.includes('permission') || result.error.includes('Permission')) {
                        errorMsg = `Permission Error: ${result.error}<br><br>
                            <strong>Solution:</strong><br>
                            1. Go to Firebase Console → Firestore Database → Rules<br>
                            2. Copy the rules from firestore.rules file<br>
                            3. Paste and click Publish<br>
                            4. Wait 10 seconds and refresh this page<br><br>
                            See QUICK_FIX_RULES.md for detailed instructions.`;
                    }
                    
                    tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">${errorMsg}</td></tr>`;
                    return;
                }
                
                if (result.success && result.orders && result.orders.length > 0) {
                    tbody.innerHTML = result.orders.map(order => {
                        const date = order.createdAt ? new Date(order.createdAt).toLocaleDateString('en-IN') : 'N/A';
                        const statusColors = {
                            'pending': 'bg-yellow-100 text-yellow-700',
                            'processing': 'bg-blue-100 text-blue-700',
                            'shipped': 'bg-purple-100 text-purple-700',
                            'delivered': 'bg-green-100 text-green-700',
                            'cancelled': 'bg-red-100 text-red-700'
                        };
                        return `
                            <tr class="hover:bg-slate-50">
                                <td class="px-6 py-4 font-mono text-sm text-slate-900">${order.orderId || order.id || 'N/A'}</td>
                                <td class="px-6 py-4">
                                    <div>
                                        <p class="font-semibold text-slate-900">${order.shipping?.name || order.customerName || 'N/A'}</p>
                                        <p class="text-sm text-slate-500">${order.shipping?.email || order.customerEmail || ''}</p>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-slate-600">${order.order?.items?.length || order.items?.length || 0} items</td>
                                <td class="px-6 py-4 font-semibold text-slate-900">₹ ${(order.order?.total || order.total || 0).toLocaleString('en-IN')}</td>
                                <td class="px-6 py-4">
                                    <span id="status-badge-${order.id}" class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[order.status] || 'bg-gray-100 text-gray-700'}">
                                        ${(order.status || 'pending')}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-slate-600">${date}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <button onclick="viewOrderDetails('${order.id}')" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm font-semibold hover:bg-indigo-200 transition">
                                            View
                                        </button>
                                        <select class="px-2 py-1 border border-slate-300 rounded text-sm" onchange="setOrderStatus('${order.id}', this.value)">
                                            <option value="pending" ${(order.status || 'pending') === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="processing" ${(order.status || 'pending') === 'processing' ? 'selected' : ''}>Processing</option>
                                            <option value="shipped" ${(order.status || 'pending') === 'shipped' ? 'selected' : ''}>Shipped</option>
                                            <option value="delivered" ${(order.status || 'pending') === 'delivered' ? 'selected' : ''}>Delivered</option>
                                            <option value="cancelled" ${(order.status || 'pending') === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">No orders found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-red-500">Error loading orders: ${error.message}</td></tr>`;
            }
        }

        // Update order status (Pending/Completed)
        async function setOrderStatus(orderId, status) {
            try {
                if (!orderId || !status) return;
                const confirmed = confirm(`Change status to "${status}" for order ${orderId}?`);
                if (!confirmed) return;

                // Disable all selects for this order row while updating
                const selectEl = document.querySelector(`select[onchange*="${orderId}"]`);
                if (selectEl) selectEl.disabled = true;

                const result = await adminFunctions.updateOrderStatus(orderId, status);
                if (!result || !result.success) {
                    throw new Error(result?.error || 'Failed to update order status');
                }

                // Update badge UI
                const badge = document.getElementById(`status-badge-${orderId}`);
                if (badge) {
                    const cls = getStatusClass(status);
                    // Reset class to base + new color
                    badge.className = `px-3 py-1 rounded-full text-xs font-semibold ${cls}`;
                    badge.textContent = status;
                }

                alert('Order status updated');
            } catch (err) {
                console.error('setOrderStatus error:', err);
                alert('Error updating order: ' + (err.message || err));
            } finally {
                const selectEl = document.querySelector(`select[onchange*="${orderId}"]`);
                if (selectEl) selectEl.disabled = false;
            }
        }

        function getStatusClass(status) {
            const map = {
                pending: 'bg-yellow-100 text-yellow-700',
                processing: 'bg-blue-100 text-blue-700',
                shipped: 'bg-purple-100 text-purple-700',
                delivered: 'bg-green-100 text-green-700',
                completed: 'bg-green-100 text-green-700',
                cancelled: 'bg-red-100 text-red-700'
            };
            return map[status] || 'bg-gray-100 text-gray-700';
        }

        // Export helpers
        async function exportOrdersData(format) {
            try {
                if (!window.exportUtils) { alert('Export utilities not loaded'); return; }
                const res = await adminFunctions.getAllOrders();
                if (res?.success && res.orders) {
                    if (format === 'csv') exportUtils.exportOrdersToCSV(res.orders);
                    else exportUtils.exportOrdersToPDF(res.orders);
                } else {
                    alert('No orders to export');
                }
            } catch (e) { console.error(e); alert('Export failed'); }
        }

        async function exportUsersData(format) {
            try {
                if (!window.exportUtils) { alert('Export utilities not loaded'); return; }
                const res = await adminFunctions.getAllUsers();
                if (res?.success && res.users) {
                    if (format === 'csv') exportUtils.exportUsersToCSV(res.users);
                    else exportUtils.exportUsersToPDF(res.users);
                } else {
                    alert('No users to export');
                }
            } catch (e) { console.error(e); alert('Export failed'); }
        }
        window.exportOrdersData = exportOrdersData;
        window.exportUsersData = exportUsersData;

        // Analytics loader
        async function loadAnalytics() {
            try {
                if (typeof adminFunctions === 'undefined') return;
                const [ordersRes, usersRes] = await Promise.all([
                    adminFunctions.getAllOrders?.(),
                    adminFunctions.getAllUsers?.()
                ]);
                const orders = ordersRes?.orders || [];
                const users = usersRes?.users || [];

                const totalOrders = orders.length;
                const totalRevenue = orders.reduce((sum, o) => sum + (o.order?.total || o.total || 0), 0);
                const avgOrderValue = totalOrders ? Math.round(totalRevenue / totalOrders) : 0;

                const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
                setText('stat-orders', String(totalOrders));
                setText('stat-revenue', `₹ ${totalRevenue.toLocaleString('en-IN')}`);
                setText('stat-aov', `₹ ${avgOrderValue.toLocaleString('en-IN')}`);
                setText('stat-users', String(users.length));

                const recent = orders.slice(0, 5);
                const container = document.getElementById('recent-orders');
                if (container) {
                    container.innerHTML = recent.length ? recent.map(order => `
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded">
                            <div>
                                <p class="font-semibold">${order.orderId || order.id}</p>
                                <p class="text-sm text-slate-600">${order.shipping?.name || order.customerName || 'N/A'}</p>
                            </div>
                            <p class="font-semibold">₹ ${(order.order?.total || order.total || 0).toLocaleString('en-IN')}</p>
                        </div>
                    `).join('') : '<p class="text-slate-500">No recent orders</p>';
                }
            } catch (e) {
                console.error('loadAnalytics error:', e);
            }
        }

        // Refresh analytics button
        document.getElementById('refresh-analytics')?.addEventListener('click', loadAnalytics);

        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) {
                console.error('Users table body not found');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">Loading users...</td></tr>';

            try {
                if (typeof adminFunctions === 'undefined' || !adminFunctions.getAllUsers) {
                    throw new Error('Admin functions not available. Please refresh the page.');
                }

                console.log('Calling getAllUsers...');
                const result = await adminFunctions.getAllUsers();
                console.log('Users result:', result);
                
                if (!result) {
                    throw new Error('No result returned from getAllUsers');
                }
                
                if (result.error) {
                    console.error('Error in result:', result.error);
                    let errorMsg = result.error;
                    
                    // Provide helpful message for permission errors
                    if (result.error.includes('permission') || result.error.includes('Permission')) {
                        errorMsg = `Permission Error: ${result.error}<br><br>
                            <strong>Solution:</strong><br>
                            1. Go to Firebase Console → Firestore Database → Rules<br>
                            2. Copy the rules from firestore.rules file<br>
                            3. Paste and click Publish<br>
                            4. Wait 10 seconds and refresh this page<br><br>
                            See QUICK_FIX_RULES.md for detailed instructions.`;
                    }
                    
                    tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">${errorMsg}</td></tr>`;
                    return;
                }
                
                if (result.success && result.users && result.users.length > 0) {
                    tbody.innerHTML = result.users.map(user => {
                        const date = (user.createdAt || user.lastUpdated) ? new Date(user.createdAt || user.lastUpdated).toLocaleDateString('en-IN') : 'N/A';
                        return `
                            <tr class="hover:bg-slate-50">
                                <td class="px-6 py-4 font-semibold text-slate-900">${user.fullName || 'N/A'}</td>
                                <td class="px-6 py-4 text-slate-600">${user.email || 'N/A'}</td>
                                <td class="px-6 py-4 text-slate-600">${user.phone || 'N/A'}</td>
                                <td class="px-6 py-4 text-slate-600">${user.address?.city || 'N/A'}</td>
                                <td class="px-6 py-4 text-slate-600">${date}</td>
                                <td class="px-6 py-4">
                                    <button onclick="viewUserDetails('${user.uid || user.id}')" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm font-semibold hover:bg-indigo-200 transition">
                                        View
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-slate-500">No users found.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Error loading users: ${error.message}</td></tr>`;
            }
        }

        async function editProduct(productId) {
            const result = await adminFunctions.getProduct(productId);
            if (result.success) {
                const product = result.product;
                document.getElementById('modal-title').textContent = 'Edit Product';
                document.getElementById('product-id').value = productId;
                document.getElementById('product-name').value = product.name || '';
                document.getElementById('product-type').value = product.type || '';
                document.getElementById('product-price').value = product.price || '';
                document.getElementById('product-sku').value = product.sku || '';
                document.getElementById('product-image').value = product.image || '';
                const imageUrlInput = document.getElementById('product-image-url');
                const imagePreview = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-img');
                if (imageUrlInput) imageUrlInput.value = product.image || '';
                if (product.image) {
                    previewImg.src = product.image;
                    imagePreview.classList.remove('hidden');
                } else {
                    imagePreview.classList.add('hidden');
                }
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-finishes').value = (product.finishes || []).join(', ');
                document.getElementById('product-active').checked = product.active !== false;
                document.getElementById('product-modal').classList.add('show');
            } else {
                alert('Error loading product: ' + result.error);
            }
        }

        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                const result = await adminFunctions.deleteProduct(productId);
                if (result.success) {
                    loadProducts();
                } else {
                    alert('Error deleting product: ' + result.error);
                }
            }
        }

        async function viewOrderDetails(orderId) {
            const result = await adminFunctions.getOrder(orderId);
            if (result.success) {
                const order = result.order;
                const content = document.getElementById('order-details-content');
                content.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Order Information</h4>
                            <div class="bg-slate-50 p-4 rounded-lg space-y-2">
                                <p><span class="font-semibold">Order ID:</span> ${order.orderId || order.id}</p>
                                <p><span class="font-semibold">Status:</span> ${order.status || 'pending'}</p>
                                <p><span class="font-semibold">Date:</span> ${new Date(order.createdAt).toLocaleString('en-IN')}</p>
                                <p><span class="font-semibold">Payment:</span> ${order.payment?.method || 'N/A'}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Shipping Address</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p>${order.shipping?.name || 'N/A'}</p>
                                <p>${order.shipping?.addressLine1 || ''}</p>
                                <p>${order.shipping?.city || ''}, ${order.shipping?.state || ''} ${order.shipping?.pincode || ''}</p>
                                <p>Email: ${order.shipping?.email || 'N/A'}</p>
                                <p>Phone: ${order.shipping?.phone || 'N/A'}</p>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Items</h4>
                            <div class="space-y-2">
                                ${(order.order?.items || []).map(item => `
                                    <div class="flex justify-between items-center bg-slate-50 p-4 rounded-lg">
                                        <div>
                                            <p class="font-semibold">${item.name}</p>
                                            <p class="text-sm text-slate-600">${item.finish || 'Standard'} × ${item.quantity}</p>
                                        </div>
                                        <p class="font-semibold">₹ ${(item.price * item.quantity).toLocaleString('en-IN')}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Totals</h4>
                            <div class="bg-slate-50 p-4 rounded-lg space-y-2">
                                <div class="flex justify-between"><span>Subtotal:</span> <span>₹ ${(order.order?.subtotal || 0).toLocaleString('en-IN')}</span></div>
                                <div class="flex justify-between"><span>Shipping:</span> <span>₹ ${(order.order?.shipping || 70).toLocaleString('en-IN')}</span></div>
                                ${order.order?.codCharge > 0 ? `<div class="flex justify-between"><span>COD Charge:</span> <span>₹ ${order.order.codCharge.toLocaleString('en-IN')}</span></div>` : ''}
                                <div class="flex justify-between font-bold text-lg border-t pt-2"><span>Total:</span> <span>₹ ${(order.order?.total || 0).toLocaleString('en-IN')}</span></div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('order-details-modal').classList.add('show');
            } else {
                alert('Error loading order: ' + result.error);
            }
        }

        async function viewUserDetails(userId) {
            console.log('=== viewUserDetails called ===');
            console.log('userId:', userId);
            console.log('userId type:', typeof userId);
            
            if (!userId) {
                alert('User ID is required');
                return;
            }
            
            const userModal = document.getElementById('user-details-modal');
            const content = document.getElementById('user-details-content');
            
            if (!userModal || !content) {
                console.error('Modal elements not found');
                console.error('userModal:', userModal);
                console.error('content:', content);
                alert('Modal elements not found. Please refresh the page.');
                return;
            }
            
            console.log('Modal elements found, showing modal...');
            
            // Show loading state
            content.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div><p class="mt-4 text-slate-600">Loading user details...</p></div>';
            userModal.classList.add('show');
            
            console.log('Modal shown, fetching user data...');
            
            try {
                if (typeof adminFunctions === 'undefined') {
                    throw new Error('Admin functions not available');
                }
                
                if (!adminFunctions.getUser) {
                    throw new Error('getUser function not available in adminFunctions');
                }
                
                console.log('Calling adminFunctions.getUser with userId:', userId);
                const result = await adminFunctions.getUser(userId);
                console.log('User details result:', result);
                console.log('Result success:', result?.success);
                console.log('Result user:', result?.user);
                console.log('Result error:', result?.error);
                
                if (result && result.success && result.user) {
                    const user = result.user;
                    console.log('User data loaded successfully:', user);
                    const joinDate = user.createdAt || user.lastUpdated || new Date().toISOString();
                    
                    console.log('Rendering user details in modal...');
                    content.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Personal Information</h4>
                            <div class="bg-slate-50 p-4 rounded-lg space-y-2">
                                <p><span class="font-semibold">Name:</span> ${user.fullName || 'N/A'}</p>
                                <p><span class="font-semibold">Email:</span> ${user.email || 'N/A'}</p>
                                <p><span class="font-semibold">Phone:</span> ${user.phone || 'N/A'}</p>
                                ${user.gender ? `<p><span class="font-semibold">Gender:</span> ${user.gender}</p>` : ''}
                                ${user.dateOfBirth ? `<p><span class="font-semibold">Date of Birth:</span> ${user.dateOfBirth}</p>` : ''}
                                ${user.occupation ? `<p><span class="font-semibold">Occupation:</span> ${user.occupation}</p>` : ''}
                                ${user.company ? `<p><span class="font-semibold">Company:</span> ${user.company}</p>` : ''}
                            </div>
                        </div>
                        ${user.address ? `
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Address</h4>
                            <div class="bg-slate-50 p-4 rounded-lg">
                                <p>${user.address.street || ''}</p>
                                ${user.address.landmark ? `<p>${user.address.landmark}</p>` : ''}
                                <p>${user.address.city || ''}, ${user.address.state || ''} ${user.address.postalCode || ''}</p>
                                <p>${user.address.country || 'India'}</p>
                            </div>
                        </div>
                        ` : ''}
                        ${user.website || user.linkedin || user.instagram ? `
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Social Links</h4>
                            <div class="bg-slate-50 p-4 rounded-lg space-y-2">
                                ${user.website ? `<p><span class="font-semibold">Website:</span> <a href="${user.website}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline" onclick="event.stopPropagation(); return true;">${user.website}</a></p>` : ''}
                                ${user.linkedin ? `<p><span class="font-semibold">LinkedIn:</span> <a href="${user.linkedin}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline" onclick="event.stopPropagation(); return true;">${user.linkedin}</a></p>` : ''}
                                ${user.instagram ? `<p><span class="font-semibold">Instagram:</span> <a href="${user.instagram}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline" onclick="event.stopPropagation(); return true;">${user.instagram}</a></p>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        <div>
                            <h4 class="font-semibold text-slate-700 mb-2">Account Information</h4>
                            <div class="bg-slate-50 p-4 rounded-lg space-y-2">
                                <p><span class="font-semibold">User ID:</span> <span class="font-mono text-sm">${userId}</span></p>
                                <p><span class="font-semibold">Joined:</span> ${new Date(joinDate).toLocaleString('en-IN')}</p>
                                ${user.lastUpdated ? `<p><span class="font-semibold">Last Updated:</span> ${new Date(user.lastUpdated).toLocaleString('en-IN')}</p>` : ''}
                                <p><span class="font-semibold">Email Verified:</span> ${user.emailVerified ? 'Yes' : 'No'}</p>
                                ${user.provider ? `<p><span class="font-semibold">Sign-in Provider:</span> ${user.provider}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Prevent any navigation from links after rendering
                setTimeout(() => {
                    const links = content.querySelectorAll('a');
                    links.forEach(link => {
                        link.addEventListener('click', (e) => {
                            // Only prevent if it's not an external link
                            if (!link.target || link.target !== '_blank') {
                                e.preventDefault();
                                e.stopPropagation();
                            }
                        });
                    });
                }, 100);
                // Modal is already shown, just ensure it stays visible
                userModal.classList.add('show');
            } else {
                const errorMsg = result?.error || 'Unknown error occurred';
                console.error('Error loading user:', errorMsg);
                console.error('Full result:', result);

                // Auto-create a minimal user profile if the current auth user matches and doc is missing
                if (errorMsg && errorMsg.toLowerCase().includes('not found') && typeof sparshAuth !== 'undefined' && sparshAuth.getCurrentUser) {
                    try {
                        const current = sparshAuth.getCurrentUser();
                        if (current && current.uid === userId) {
                            const isAdminEmail = (typeof adminFunctions !== 'undefined' && adminFunctions.ADMIN_EMAIL) ? (current.email || '').toLowerCase() === adminFunctions.ADMIN_EMAIL.toLowerCase() : false;
                            const profileData = {
                                email: current.email || '',
                                fullName: current.displayName || (current.email ? current.email.split('@')[0] : 'Admin'),
                                emailVerified: !!current.emailVerified,
                                provider: (current.providerData && current.providerData[0] && current.providerData[0].providerId) || 'password',
                                role: isAdminEmail ? 'admin' : 'user',
                                createdAt: new Date().toISOString(),
                                lastUpdated: new Date().toISOString()
                            };
                            console.log('Creating minimal user profile for missing user doc:', profileData);
                            if (sparshAuth.saveUserProfile) {
                                await sparshAuth.saveUserProfile(userId, profileData);
                                const retry = await adminFunctions.getUser(userId);
                                if (retry && retry.success && retry.user) {
                                    // Recursively render now that profile exists
                                    return await viewUserDetails(userId);
                                }
                            }
                        }
                    } catch (autoErr) {
                        console.warn('Auto-create user profile failed:', autoErr);
                    }
                }

                content.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-600 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-semibold text-slate-900 mb-2">Error Loading User</p>
                        <p class="text-slate-600 mb-4">${errorMsg}</p>
                <button onclick="closeUserDetailsModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Close
                        </button>
                    </div>
                `;
                userModal.classList.add('show');
            }
            } catch (error) {
                console.error('Exception in viewUserDetails:', error);
                console.error('Error stack:', error.stack);
                content.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-600 mb-4">
                            <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-lg font-semibold text-slate-900 mb-2">Error Loading User</p>
                        <p class="text-slate-600 mb-4">${error.message || 'An unexpected error occurred'}</p>
                        <button onclick="closeUserDetailsModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Close
                        </button>
                    </div>
                `;
                userModal.classList.add('show');
            }
        }

        // View admin profile
        async function viewAdminProfile() {
            console.log('Loading admin profile...');
            
            try {
                if (typeof sparshAuth === 'undefined' || !sparshAuth.getCurrentUser) {
                    throw new Error('Authentication service not available');
                }

                // Wait for Firebase auth to hydrate before checking current user
                if (typeof sparshAuth.waitForAuthReady === 'function') {
                    await sparshAuth.waitForAuthReady();
                } else {
                    await new Promise(r => setTimeout(r, 300));
                }
                
                const user = sparshAuth.getCurrentUser();
                console.log('Current user:', user);
                
                if (user && user.uid) {
                    await viewUserDetails(user.uid);
                } else {
                    // Try to get user from localStorage as fallback
                    const storedUser = localStorage.getItem('sparshUser');
                    if (storedUser) {
                        try {
                            const userData = JSON.parse(storedUser);
                            if (userData.uid) {
                                console.log('Using stored user UID:', userData.uid);
                                await viewUserDetails(userData.uid);
                                return;
                            }
                        } catch (e) {
                            console.error('Error parsing stored user:', e);
                        }
                    }
                    
                    alert('Unable to load admin profile. Please make sure you are logged in.');
                }
            } catch (error) {
                console.error('Error in viewAdminProfile:', error);
                alert('Error loading admin profile: ' + error.message);
            }
        }

        // Upload product image to Firebase Storage
        async function uploadProductImage(file) {
            const progressBar = document.getElementById('image-progress-bar');
            const progressText = document.getElementById('image-progress-text');
            const progressContainer = document.getElementById('image-upload-progress');
            const hiddenImageInput = document.getElementById('product-image');
            
            try {
                progressContainer.classList.remove('hidden');
                progressText.textContent = 'Uploading...';
                
                // Import Firebase Storage modules
                const { ref, uploadBytesResumable, getDownloadURL } = await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js');
                const storage = window.firebaseStorage;
                
                if (!storage) {
                    throw new Error('Firebase Storage not initialized');
                }
                
                // Create unique filename
                const timestamp = Date.now();
                const fileName = `products/${timestamp}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const storageRef = ref(storage, fileName);
                
                // Upload file
                const uploadTask = uploadBytesResumable(storageRef, file);
                
                // Monitor upload progress
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progressBar.style.width = progress + '%';
                        progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        progressContainer.classList.add('hidden');
                        alert('Error uploading image: ' + error.message);
                    },
                    async () => {
                        // Upload completed successfully
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        hiddenImageInput.value = downloadURL;
                        progressText.textContent = 'Upload complete!';
                        
                        setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            progressBar.style.width = '0%';
                        }, 2000);
                    }
                );
            } catch (error) {
                console.error('Error uploading image:', error);
                progressContainer.classList.add('hidden');
                alert('Error uploading image: ' + error.message);
            }
        }

        // Make functions globally available
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.viewOrderDetails = viewOrderDetails;
        window.viewUserDetails = viewUserDetails;
        window.viewAdminProfile = viewAdminProfile;
        window.uploadProductImage = uploadProductImage;
        window.setOrderStatus = setOrderStatus;
    </script>
</body>
</html>

